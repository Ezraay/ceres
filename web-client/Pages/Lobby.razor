@page "/Lobby"
@using web_client.Shared.Lobby
@using Microsoft.AspNetCore.SignalR.Client;
@using Ceres.Core.Networking.Messages;
@using Ceres.Core.Entities
@using webclient.Services
@implements IAsyncDisposable
@inject IConfiguration Configuration
@inject LobbyHub LobbyHubService;

<h3>Lobby - @(IsConnected ? "Connected" : "Disconnected")</h3>

<CascadingValue Value="IsConnected">
    <GamesList @ref="GamesList"/>
    <hr>
    <ClientsList @ref="ClientList"/>
    <hr>
    <LobbyChat @ref="LobbyChat" LobbyHubConnection="hubConnection"   />
</CascadingValue>

@code {

    private static HubConnection? hubConnection;
    
    private LobbyChat? LobbyChat { get; set; }
    private ClientsList? ClientList { get; set; }
    private GamesList? GamesList { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        // var uri = $"{Configuration.GetSection("ceres")["server-address"]}/{Configuration.GetSection("ceres")["lobby-hub"]}";
        // hubConnection = new HubConnectionBuilder() 
        //     .WithUrl(uri)
        //     .WithAutomaticReconnect()
        //     .Build();
        hubConnection = LobbyHubService.LobbyHubConnection;

        hubConnection.On<ReceiveMessageMessage>("ReceiveMessage", LobbyChatAddMessage);
        hubConnection.On<ClientsListMessage>("ClientsList", ClientsListUpdate);
        hubConnection.On<UpdateGamesMessage>("UpdateGames",GamesListUpdate);
        
        hubConnection.Closed += NotifyUserOfServerDisconnected;
        hubConnection.Reconnecting += NotifyUserOfReconnecting;
        hubConnection.Reconnected += NotifyUserOfReconnected;
        
        

        
        await ConnectWithRetryAsync(CancellationToken.None);
    }

    private void GamesListUpdate(UpdateGamesMessage msg)
    {
        if (GamesList == null) return;
        GamesList.Games = msg.GameIds.ToList();
        GamesList.Refresh();
    }

    private void LobbyChatAddMessage(ReceiveMessageMessage msg) => LobbyChat?.AddMessage(msg.UserName, msg.MessageText);

    private void ClientsListUpdate(ClientsListMessage msg)
    {
        if (ClientList == null) return;
        ClientList.Clients = msg.LobbyUsers.ToList();
        ClientList.Refresh();
    }

    private Task NotifyUserOfReconnected(string? connectionId)
    {
        Console.WriteLine($"Lobby Connection successfully reconnected. The ConnectionId is now: {connectionId}");
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task NotifyUserOfServerDisconnected(Exception? e)
    {
        Console.WriteLine(e != null ? $"Lobby Connection: Connection to server closed. Error: {e!.Message}" : $"Lobby Connection closed.");
        StateHasChanged();
        await ConnectWithRetryAsync(CancellationToken.None);
        // return Task.CompletedTask;
    }
    
    private Task NotifyUserOfReconnecting(Exception? e)
    {
        Console.WriteLine($"Lobby Connection started to reconnect due to an error: {e!.Message}");
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private async Task<bool> ConnectWithRetryAsync( CancellationToken token){
    // Keep trying to until we can start or the token is canceled.
        while (true)
        {
            try
            {
                Console.WriteLine($"Lobby Connection - trying to connect..");
                if (hubConnection != null)
                    await hubConnection.StartAsync(token);
                Console.WriteLine($"Lobby Connection - connected.");
                StateHasChanged();
                return true;
            }
            catch when (token.IsCancellationRequested)
            {
                return false;
            }
            catch
            {
                // Failed to connect, trying again in 5000 ms.
                await Task.Delay(5000, token);
            }
        }}


    private bool IsConnected
    {
        get
        {
            if (hubConnection == null) return false;
            return hubConnection.State == HubConnectionState.Connected;
        }
    }


    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
            await hubConnection.DisposeAsync();
    }

    

}